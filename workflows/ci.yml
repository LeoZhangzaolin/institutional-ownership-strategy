name: CI Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create required directories
      run: |
        mkdir -p data/13f_parquet
        mkdir -p data/cache
        mkdir -p data/models
        mkdir -p data/signals
        mkdir -p logs
        mkdir -p reports
        mkdir -p config
    
    - name: Create dummy config file
      run: |
        cat > config/config.yaml << 'EOF'
        data:
          wrds_username: "test_user"
          start_date: "2020-01-01"
          end_date: "2024-12-31"
          paths:
            13f_parquet: "data/13f_parquet"
            cache: "data/cache"
            models: "data/models"
            signals: "data/signals"
            logs: "logs"
        
        features:
          include_prefixes:
            - "mom_"
            - "vol_"
            - "io_"
            - "sk_"
          enable_feature_engineering: true
          enable_sector_models: false
          max_interaction_features: 15
          max_nonlinear_features: 18
          max_rank_features: 12
        
        models:
          enable_regime_models: true
          enable_ensemble: true
          enable_smart_ensemble: true
          enable_quality_filters: true
          enable_optimization: true
          enable_adaptive_k: true
          enable_xgboost: true
          max_train_quarters: 31
          tune_every_quarters: 2
          reuse_best_params: true
          random_seed: 42
          n_cv_splits: 2
          min_train_quarters: 12
          embargo_quarters: 1
          n_parallel_models: 2
        
        regimes:
          high_vol:
            risk_aversion: 3.5
            max_pos: 0.10
            top_k: 7
            turnover_penalty: 0.002
          bear:
            risk_aversion: 3.0
            max_pos: 0.12
            top_k: 8
            turnover_penalty: 0.0015
          normal:
            risk_aversion: 1.5
            max_pos: 0.16
            top_k: 11
            turnover_penalty: 0.0008
          bull:
            risk_aversion: 0.8
            max_pos: 0.22
            top_k: 13
            turnover_penalty: 0.0003
        
        ensemble:
          var_lookback_q: 8
          min_prediction_confidence: 0.15
          min_model_agreement: 0.5
        
        portfolio:
          initial_capital: 1000000
          universe: "sp500"
          predict_excess: true
          ann: 4
        
        trading:
          broker: "alpaca"
          paper_trading: true
          order_type: "limit"
          limit_buffer_bps: 20
          time_in_force: "DAY"
          execution_time: "09:45"
        
        broker:
          interactive_brokers:
            host: "127.0.0.1"
            port: 7497
            client_id: 1
            timeout: 60
          alpaca:
            api_key: "test_key"
            secret_key: "test_secret"
            base_url: "https://paper-api.alpaca.markets"
        
        risk:
          max_daily_loss_pct: 0.02
          max_drawdown_pct: 0.15
          max_single_position_loss: 0.01
          circuit_breaker_enabled: true
          halt_on_daily_loss: true
          halt_on_drawdown: true
          min_fill_rate: 0.85
          max_gross_exposure: 2.0
          max_net_exposure: 0.05
        
        monitoring:
          enable_alerts: false
          log_level: "INFO"
          log_to_file: true
          log_to_console: true
        EOF
    
    - name: Run import tests
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        
        # Test all module imports
        print('Testing imports...')
        
        try:
            from utils import load_config, setup_logging
            print('✓ utils')
        except Exception as e:
            print(f'✗ utils: {e}')
            sys.exit(1)
        
        try:
            from data_pipeline import DataPipeline
            print('✓ data_pipeline')
        except Exception as e:
            print(f'✗ data_pipeline: {e}')
            sys.exit(1)
        
        try:
            from feature_engineering import winsorize_series, robust_zscore
            print('✓ feature_engineering')
        except Exception as e:
            print(f'✗ feature_engineering: {e}')
            sys.exit(1)
        
        try:
            from regime_detection import detect_current_regime
            print('✓ regime_detection')
        except Exception as e:
            print(f'✗ regime_detection: {e}')
            sys.exit(1)
        
        try:
            from model_training import RegimeEnsembleModel
            print('✓ model_training')
        except Exception as e:
            print(f'✗ model_training: {e}')
            sys.exit(1)
        
        try:
            from portfolio_optimization import optimize_portfolio_regime_adaptive
            print('✓ portfolio_optimization')
        except Exception as e:
            print(f'✗ portfolio_optimization: {e}')
            sys.exit(1)
        
        print('All imports successful!')
        "
    
    - name: Run unit tests
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        import pandas as pd
        import numpy as np
        from utils import load_config
        from feature_engineering import winsorize_series, robust_zscore
        from regime_detection import detect_current_regime
        
        print('Running unit tests...')
        
        # Test 1: Configuration loading
        print('Test 1: Configuration loading...')
        config = load_config('config/config.yaml')
        assert 'data' in config
        assert 'models' in config
        print('✓ Config loads correctly')
        
        # Test 2: Winsorization
        print('Test 2: Winsorization...')
        s = pd.Series(np.random.randn(100))
        s_wins = winsorize_series(s)
        assert len(s_wins) == len(s)
        assert s_wins.min() >= s.quantile(0.01)
        assert s_wins.max() <= s.quantile(0.99)
        print('✓ Winsorization works')
        
        # Test 3: Z-score
        print('Test 3: Robust z-score...')
        s_z = robust_zscore(s)
        assert abs(s_z.median()) < 0.5
        print('✓ Z-score works')
        
        # Test 4: Regime detection
        print('Test 4: Regime detection...')
        returns = pd.Series(np.random.randn(20) * 0.02)
        regime, metrics = detect_current_regime(returns)
        assert regime in ['bull', 'bear', 'normal', 'high_vol']
        print(f'✓ Regime detection works (detected: {regime})')
        
        print('All unit tests passed!')
        "
    
    - name: Check code structure
      run: |
        echo "Checking required files..."
        
        # Check source files
        test -f src/__init__.py && echo "✓ src/__init__.py" || exit 1
        test -f src/utils.py && echo "✓ src/utils.py" || exit 1
        test -f src/data_pipeline.py && echo "✓ src/data_pipeline.py" || exit 1
        test -f src/feature_engineering.py && echo "✓ src/feature_engineering.py" || exit 1
        test -f src/regime_detection.py && echo "✓ src/regime_detection.py" || exit 1
        test -f src/model_training.py && echo "✓ src/model_training.py" || exit 1
        test -f src/portfolio_optimization.py && echo "✓ src/portfolio_optimization.py" || exit 1
        test -f src/order_execution.py && echo "✓ src/order_execution.py" || exit 1
        test -f src/risk_management.py && echo "✓ src/risk_management.py" || exit 1
        
        # Check scripts
        test -f scripts/quarterly_update.py && echo "✓ scripts/quarterly_update.py" || exit 1
        test -f scripts/live_trading.py && echo "✓ scripts/live_trading.py" || exit 1
        test -f scripts/monitor_daily.py && echo "✓ scripts/monitor_daily.py" || exit 1
        test -f scripts/verify_positions.py && echo "✓ scripts/verify_positions.py" || exit 1
        
        # Check documentation
        test -f README.md && echo "✓ README.md" || exit 1
        test -f requirements.txt && echo "✓ requirements.txt" || exit 1
        
        echo "All required files present!"
    
    - name: Check Python syntax
      run: |
        python -m py_compile src/*.py
        python -m py_compile scripts/*.py
        echo "✓ All Python files have valid syntax"
    
    - name: Summary
      run: |
        echo "================================================"
        echo "✅ CI Tests Passed"
        echo "================================================"
        echo "- Environment setup: OK"
        echo "- Dependencies installed: OK"
        echo "- Module imports: OK"
        echo "- Unit tests: OK"
        echo "- Code structure: OK"
        echo "- Python syntax: OK"
        echo "================================================"